AWSTemplateFormatVersion: "2010-09-09"
Description: "Security Groups fuer Web- und SSH-Zugriff"

Parameters:
  ProjectName:
    Type: String
    Default: "mein-projekt"
    Description: "Name fuer alle Ressourcen"
  
  Environment:
    Type: String
    Default: "dev"
    AllowedValues: [dev, test, prod]
    Description: "Umgebung (dev, test, prod)"
    
  VPCId:
    Type: String
    Description: "ID der VPC (aus dem VPC Template)"

Resources:
  # Security Group fuer Web-Server (HTTP/HTTPS von ueberall)
  WebServerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub "${ProjectName}-${Environment}-web-sg"
      GroupDescription: "Security Group fuer Web-Server - erlaubt HTTP und HTTPS"
      VpcId: !Ref VPCId
      SecurityGroupIngress:
        # HTTP von ueberall
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: "HTTP von ueberall"
        # HTTPS von ueberall  
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: "HTTPS von ueberall"
      SecurityGroupEgress:
        # Ausgehender Traffic zu ueberall erlaubt
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: "Ausgehender Traffic zu ueberall"
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-${Environment}-web-sg"

  # Security Group fuer SSH-Zugriff (nur aus bestimmten IPs)
  SSHSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub "${ProjectName}-${Environment}-ssh-sg"
      GroupDescription: "Security Group fuer SSH-Zugriff - nur aus bestimmten IPs"
      VpcId: !Ref VPCId
      SecurityGroupIngress:
        # SSH nur aus deinem Buero/Home (ACHTUNG: IP anpassen!)
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
          Description: "SSH Zugriff (ACHTUNG: IP einschraenken!)"
      SecurityGroupEgress:
        # Ausgehender Traffic zu ueberall erlaubt
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: "Ausgehender Traffic zu ueberall"
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-${Environment}-ssh-sg"

  # Security Group fuer Datenbank (nur aus Web-Security Group)
  DatabaseSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub "${ProjectName}-${Environment}-db-sg"
      GroupDescription: "Security Group fuer Datenbank - nur von Web-Servern erreichbar"
      VpcId: !Ref VPCId
      SecurityGroupIngress:
        # MySQL/MariaDB nur von Web-Security Group
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref WebServerSecurityGroup
          Description: "MySQL von Web-Servern"
        # PostgreSQL nur von Web-Security Group
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref WebServerSecurityGroup
          Description: "PostgreSQL von Web-Servern"
      SecurityGroupEgress:
        # Kein ausgehender Traffic noetig fuer Datenbank
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: "HTTP fuer Updates (falls noetig)"
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-${Environment}-db-sg"

Outputs:
  WebServerSecurityGroupId:
    Description: "ID der Web-Server Security Group"
    Value: !Ref WebServerSecurityGroup
    
  SSHSecurityGroupId:
    Description: "ID der SSH Security Group"
    Value: !Ref SSHSecurityGroup
    
  DatabaseSecurityGroupId:
    Description: "ID der Datenbank Security Group"
    Value: !Ref DatabaseSecurityGroup